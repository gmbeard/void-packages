#!/bin/sh
bin="nvidia-persistenced"
rundir="/var/run/${bin}"
pidfile="${rundir}/${bin}.pid"

/usr/bin/${bin} ${@}
exitcode=$?
[ ${exitcode} -ne 0 ] && exit ${exitcode}

# Allow the daemon some time to create its
# PID file...
sleep 1

if [ -r "${pidfile}" ]; then
    read procid < "${pidfile}"
    waitpid -e ${procid}
fi

# We might have been signalled, so kill the
# daemon...
kill ${procid} || true
