# Template file for 'MangoHud-nvidia'
pkgname=MangoHud-nvidia
version=0.7.2
revision=1
build_style=meson
configure_args="-Dwith_xnvctrl=disabled -Dwith_nvml=enabled -Duse_system_spdlog=enabled"
hostmakedepends="python3-Mako glslang pkg-config"
makedepends="libglvnd-devel dbus-devel vulkan-loader-devel
spdlog json-c++ wayland-devel libxkbcommon-devel"
short_desc="Vulkan and OpenGL overlay for monitoring FPS, temperatures and more"
maintainer="gmbeard <gmbeard@googlemail.com>"
license="MIT,custom:NVIDIA"
homepage="https://github.com/flightlessmango/MangoHud"
distfiles="https://github.com/flightlessmango/MangoHud/releases/download/v${version}/MangoHud-v${version}-Source.tar.xz"
checksum=114ad3ea87b1db7358816c7b8e7843aaee356ff048b9e15d6fff02d89414841b
conflicts=MangoHud
repository=nonfree
python_version=3
lib32files="/usr/share/vulkan/implicit_layer.d/MangoHud.x86.json"

if [ "$XBPS_TARGET_LIBC" = "musl" ]; then
	configure_args+=" -Ddynamic_string_tokens=false"
fi

post_install() {
	# Extract the NVIDIA license from the nvml.h header
	head -n $( \
		awk '/NVML API Reference/{ print NR-1; exit }' ${wrksrc}/include/nvml.h \
		) ${wrksrc}/include/nvml.h \
		| sed 's;^\([/ ]\?\)\*/\?;;g' >${wrksrc}/LICENSE-NVIDIA

	vlicense LICENSE
	vlicense LICENSE-NVIDIA
}
